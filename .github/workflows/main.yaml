name: Pi-hole & Dynatrace Deployment on Azure

on:
  workflow_dispatch:

jobs:
  provision-vms:
    name: Provisions all Azure resources (VMs, IPs, etc.)
    runs-on: ubuntu-latest
    env:
      AZURE_RESOURCE_GROUP: pihole-dynatrace-rg
      AZURE_LOCATION: eastus
      PIHOLE_VM_NAME: pihole-vm
      DYNATRACE_VM_NAME: dynatrace-vm
      VM_USERNAME: nicolasnk
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Run PowerShell provisioning script
        shell: pwsh
        run: |
          ./Invoke-AzureProvisioning.ps1 -resourceGroupName $env:AZURE_RESOURCE_GROUP -location $env:AZURE_LOCATION -vmPiholeName $env:PIHOLE_VM_NAME -vmDynatraceName $env:DYNATRACE_VM_NAME -username $env:VM_USERNAME -sshKeyContent '${{ secrets.SSH_PUBLIC_KEY }}'

  install-applications:
    name: Installs applications on the VMs
    runs-on: ubuntu-latest
    needs: provision-vms
    env:
      AZURE_RESOURCE_GROUP: pihole-dynatrace-rg
      VM_USERNAME: nicolasnk
      SSH_KEY_PATH: ~/.ssh/id_gh_actions
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up SSH key for VMs
        run: |
          mkdir -p ~/.ssh/
          # Use printf to preserve exact key format
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ${{ env.SSH_KEY_PATH }}
          chmod 600 ${{ env.SSH_KEY_PATH }}
          # Validate key
          ssh-keygen -y -P "" -f ${{ env.SSH_KEY_PATH }} > ~/.ssh/id_gh_actions.pub.test || { echo "Error: SSH private key is invalid (likely not a private key)"; exit 1; }
          echo "SSH key fingerprint: $(ssh-keygen -lf ${{ env.SSH_KEY_PATH }})"
          # Add known hosts to avoid prompts
          ssh-keyscan -H ${{ env.PIHOLE_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H ${{ env.DYNATRACE_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Wait for VM provisioning
        run: |
          echo "Waiting 60 seconds for VMs and public IPs to stabilize..."
          sleep 60
      - name: Debug Azure resources
        run: |
          echo "Listing resource groups..."
          az group list --query "[].name" -o tsv
          echo "Listing public IPs in resource group ${{ env.AZURE_RESOURCE_GROUP }}..."
          az network public-ip list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[].{name:name, ipAddress:ipAddress}" -o table
      - name: Get Pi-hole VM Public IP
        id: get-pihole-ip
        run: |
          echo "Checking if pihole-public-ip exists..."
          for attempt in {1..3}; do
            az network public-ip show --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --name "pihole-public-ip" --query "name" -o tsv && break || { echo "Attempt $attempt: Public IP pihole-public-ip not found, retrying..."; sleep 10; }
            [ $attempt -eq 3 ] && { echo "Error: Public IP pihole-public-ip not found after retries"; exit 1; }
          done
          PIHOLE_IP=$(az network public-ip show --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --name "pihole-public-ip" --query "ipAddress" -o tsv)
          if [ -z "$PIHOLE_IP" ]; then
            echo "Error: Failed to retrieve Pi-hole VM public IP after retries"
            exit 1
          fi
          echo "PIHOLE_IP=$PIHOLE_IP" >> $GITHUB_ENV
          echo "Pi-hole VM IP: $PIHOLE_IP"
      - name: Get Dynatrace VM Public IP
        id: get-dynatrace-ip
        run: |
          echo "Checking if dynatrace-public-ip exists..."
          for attempt in {1..3}; do
            az network public-ip show --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --name "dynatrace-public-ip" --query "name" -o tsv && break || { echo "Attempt $attempt: Public IP dynatrace-public-ip not found, retrying..."; sleep 10; }
            [ $attempt -eq 3 ] && { echo "Error: Public IP dynatrace-public-ip not found after retries"; exit 1; }
          done
          DYNATRACE_IP=$(az network public-ip show --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --name "dynatrace-public-ip" --query "ipAddress" -o tsv)
          if [ -z "$DYNATRACE_IP" ]; then
            echo "Error: Failed to retrieve Dynatrace VM public IP after retries"
            exit 1
          fi
          echo "DYNATRACE_IP=$DYNATRACE_IP" >> $GITHUB_ENV
          echo "Dynatrace VM IP: $DYNATRACE_IP"
      - name: Test SSH connectivity
        run: |
          echo "Testing SSH to Pi-hole VM (${{ env.PIHOLE_IP }})..."
          ssh -v -i ${{ env.SSH_KEY_PATH }} -o StrictHostKeyChecking=no ${{ env.VM_USERNAME }}@${{ env.PIHOLE_IP }} "echo 'SSH test successful'" || { echo "Error: Failed to connect to Pi-hole VM"; exit 1; }
          echo "Testing SSH to Dynatrace VM (${{ env.DYNATRACE_IP }})..."
          ssh -v -i ${{ env.SSH_KEY_PATH }} -o StrictHostKeyChecking=no ${{ env.VM_USERNAME }}@${{ env.DYNATRACE_IP }} "echo 'SSH test successful'" || { echo "Error: Failed to connect to Dynatrace VM"; exit 1; }
      - name: Install Pi-hole
        shell: pwsh
        run: |
          pwsh -File ./provision-pihole-dynatrace.ps1 -VmPublicIp "${{ env.PIHOLE_IP }}" -VmUsername "${{ env.VM_USERNAME }}" -SshPrivateKeyPath "${{ env.SSH_KEY_PATH }}"
      - name: Wait for Pi-hole to stabilize
        run: |
          echo "Waiting 60 seconds for Pi-hole to stabilize..."
          sleep 60
      - name: Verify Pi-hole installation
        run: |
          for attempt in {1..3}; do
            echo "Attempt $attempt: Testing SSH connection to ${{ env.PIHOLE_IP }}..."
            ssh -v -i ${{ env.SSH_KEY_PATH }} -o StrictHostKeyChecking=no ${{ env.VM_USERNAME }}@${{ env.PIHOLE_IP }} "echo 'SSH test successful'" && break || { echo "SSH attempt $attempt failed"; sleep 10; }
          done
          PIHOLE_STATUS=$(ssh -i ${{ env.SSH_KEY_PATH }} -o StrictHostKeyChecking=no ${{ env.VM_USERNAME }}@${{ env.PIHOLE_IP }} "sudo systemctl is-active pihole-FTL 2>/dev/null" || echo "failed")
          if [ "$PIHOLE_STATUS" != "active" ]; then
            echo "Error: Pi-hole installation failed or service is not running on ${{ env.PIHOLE_IP }}. Status: $PIHOLE_STATUS"
            exit 1
          else
            echo "Pi-hole is running on ${{ env.PIHOLE_IP }}"
          fi
      - name: Install Dynatrace
        shell: pwsh
        run: |
          pwsh -File ./provision-pihole-dynatrace.ps1 -VmPublicIp "${{ env.DYNATRACE_IP }}" -VmUsername "${{ env.VM_USERNAME }}" -SshPrivateKeyPath "${{ env.SSH_KEY_PATH }}" -DynatraceApiToken "${{ secrets.DYNATRACE_API_TOKEN }}" -DynatraceEnvUrl "${{ secrets.DYNATRACE_ENV_URL }}"
      - name: Wait for Dynatrace to stabilize
        run: |
          echo "Waiting 60 seconds for Dynatrace to stabilize..."
          sleep 60
      - name: Verify Dynatrace installation
        run: |
          for attempt in {1..3}; do
            echo "Attempt $attempt: Testing SSH connection to ${{ env.DYNATRACE_IP }}..."
            ssh -v -i ${{ env.SSH_KEY_PATH }} -o StrictHostKeyChecking=no ${{ env.VM_USERNAME }}@${{ env.DYNATRACE_IP }} "echo 'SSH test successful'" && break || { echo "SSH attempt $attempt failed"; sleep 10; }
          done
          DYNATRACE_STATUS=$(ssh -i ${{ env.SSH_KEY_PATH }} -o StrictHostKeyChecking=no ${{ env.VM_USERNAME }}@${{ env.DYNATRACE_IP }} "pgrep -f dynatrace >/dev/null && echo 'active' || echo 'failed'" || echo "failed")
          if [ "$DYNATRACE_STATUS" != "active" ]; then
            echo "Error: Dynatrace installation failed or service is not running on ${{ env.DYNATRACE_IP }}. Status: $DYNATRACE_STATUS"
            exit 1
          else
            echo "Dynatrace is running on ${{ env.DYNATRACE_IP }}"
          fi

  cleanup-resources:
    name: Cleans up resources on failure
    runs-on: ubuntu-latest
    needs: [install-applications]
    if: failure()
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Clean up resources
        run: |
          az group delete --name "pihole-dynatrace-rg" --yes --no-wait